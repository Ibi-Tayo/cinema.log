<div class="recommendations-container" data-testid="recommendations-container">
  <p-toast />

  <!-- Header -->
  <div class="recommendations-header" data-testid="recommendations-header">
    <button class="back-button" (click)="goBack()" data-testid="recommendations-back-button">
      <lord-icon
        src="https://cdn.lordicon.com/zmkotitn.json"
        trigger="hover"
        style="width: 32px; height: 32px; transform: rotate(180deg)"
        colors="primary:#D3D3D3"
      ></lord-icon>
    </button>
    <h1 class="page-title">
      <lord-icon
        src="https://cdn.lordicon.com/nocovwne.json"
        trigger="loop"
        style="width: 40px; height: 40px; margin-right: 8px"
        colors="primary:#D3D3D3"
      ></lord-icon>
      Find Films to Review
    </h1>
  </div>

  <!-- Seed Selection Step -->
  @if (isInSeedStep()) {
    <div class="seed-selection-section" data-testid="recommendations-seed-section">
      <div class="instructions" data-testid="recommendations-seed-instructions">
        <h2 data-testid="recommendations-seed-title">Select 3 Films You've Seen</h2>
        <p data-testid="recommendations-seed-description">
          These films will help us understand your taste and generate
          personalised recommendations so we can build up a network of films
          that you have seen. (Try to pick a variety of genres)
        </p>
      </div>

      <!-- Selected Seed Films -->
      <div class="seed-films-list" data-testid="recommendations-seed-films-list">
        <h3 data-testid="recommendations-seed-films-count">Selected Films ({{ seedFilms().length }}/3)</h3>
        @if (seedFilms().length === 0) {
          <div class="empty-state" data-testid="recommendations-seed-empty-state">
            <lord-icon
              src="https://cdn.lordicon.com/fpmskzsv.json"
              trigger="loop"
              style="width: 80px; height: 80px"
              colors="primary:#D3D3D3"
            ></lord-icon>
            <p>Search and add 3 films below to get started</p>
          </div>
        }
        <div class="seed-films-grid" data-testid="recommendations-seed-films-grid">
          @for (film of seedFilms(); track film.id) {
            <div class="seed-film-card" [attr.data-testid]="'recommendations-seed-film-' + film.id">
              @if (film.posterUrl) {
                <img
                  [src]="getPosterUrl(film.posterUrl, 'w185')"
                  [alt]="film.title"
                />
              } @else {
                <div class="poster-placeholder">
                  <i class="pi pi-image"></i>
                </div>
              }
              <div class="film-info">
                <h4>{{ film.title }}</h4>
                <p>{{ film.releaseYear }}</p>
              </div>
              <button class="remove-button" (click)="removeSeedFilm(film)">
                <i class="pi pi-times"></i>
              </button>
            </div>
          }
        </div>
      </div>

      <!-- Search Section -->
      <div class="search-section" data-testid="recommendations-search-section">
        <h3 data-testid="recommendations-search-title">Search for Films</h3>
        <p-iconfield iconPosition="left">
          <p-inputicon class="pi pi-search" />
          <input
            id="recommendations-film-search"
            pInputText
            type="text"
            [(ngModel)]="searchQuery"
            (ngModelChange)="onSearchInput()"
            placeholder="Search for a film..."
            class="search-input"
            data-testid="recommendations-search-input"
          />
        </p-iconfield>

        <!-- Loading State -->
        @if (isSearching()) {
          <div class="search-results" data-testid="recommendations-search-loading">
            @for (i of [1, 2, 3]; track i) {
              <div class="skeleton-card">
                <p-skeleton width="100%" height="200px" />
                <p-skeleton width="80%" height="1.5rem" class="mt-2" />
                <p-skeleton width="60%" height="1rem" class="mt-2" />
              </div>
            }
          </div>
        }

        <!-- Search Results -->
        @if (searchResults().length > 0 && !isSearching()) {
          <div class="search-results" data-testid="recommendations-search-results">
            @for (film of searchResults(); track film.id) {
              <div class="search-result-card" (click)="addSeedFilm(film)" [attr.data-testid]="'recommendations-search-result-' + film.id">
                @if (film.posterUrl) {
                  <img
                    [src]="getPosterUrl(film.posterUrl, 'w780')"
                    [alt]="film.title"
                  />
                } @else {
                  <div class="poster-placeholder-large">
                    <i class="pi pi-image"></i>
                  </div>
                }
                <div class="film-details">
                  <h4>{{ film.title }}</h4>
                  <p>{{ film.releaseYear }}</p>
                </div>
                <i class="pi pi-plus add-icon"></i>
              </div>
            }
          </div>
        }

        <!-- Search Error -->
        @if (searchError()) {
          <div class="error-message">
            <i class="pi pi-exclamation-circle"></i>
            <p>{{ searchError() }}</p>
          </div>
        }
      </div>

      <!-- Start Button -->
      <div class="action-section" data-testid="recommendations-action-section">
        <p-button
          label="Start Generating Recommendations"
          icon="pi pi-play"
          [disabled]="!canStartGenerating() || isLoadingRecommendations()"
          [loading]="isLoadingRecommendations()"
          (onClick)="startGeneratingRecommendations()"
          styleClass="p-button-lg p-button-success"
          data-testid="recommendations-start-button"
        />
      </div>
    </div>
  }

  <!-- Recommendations Step -->
  @if (isInRecommendationStep()) {
    <div class="recommendations-section" data-testid="recommendations-section">
      <div class="round-info" data-testid="recommendations-round-info">
        <h2 data-testid="recommendations-round-number">Round {{ currentRound() }}</h2>
        <div class="selection-counter" data-testid="recommendations-selection-counter">
          <p-chip
            [label]="'Selected: ' + selectedSeenCount() + '/10'"
            [styleClass]="selectedSeenCount() >= 10 ? 'limit-reached' : ''"
          />
        </div>
      </div>

      <div class="instructions">
        <p>Select the films you've seen (maximum 10 per round):</p>
      </div>

      <!-- Loading State -->
      @if (isLoadingRecommendations()) {
        <div class="recommendations-grid">
          @for (i of [1, 2, 3, 4, 5, 6]; track i) {
            <div class="skeleton-card">
              <p-skeleton width="100%" height="300px" />
              <p-skeleton width="80%" height="1.5rem" class="mt-2" />
              <p-skeleton width="60%" height="1rem" class="mt-2" />
            </div>
          }
        </div>
      }

      <!-- Recommendations Grid -->
      @if (!isLoadingRecommendations() && recommendedFilms().length > 0) {
        <div class="recommendations-grid" data-testid="recommendations-grid">
          @for (selection of recommendedFilms(); track selection.film.id) {
            <div
              class="recommendation-card"
              [class.selected]="selection.hasSeen"
              (click)="toggleFilmSeen(selection)"
              [attr.data-testid]="'recommendations-card-' + selection.film.id"
            >
              @if (selection.film.posterUrl) {
                <img
                  [src]="getPosterUrl(selection.film.posterUrl, 'w342')"
                  [alt]="selection.film.title"
                />
              } @else {
                <div class="poster-placeholder-card">
                  <i class="pi pi-image"></i>
                </div>
              }
              <div class="card-overlay">
                @if (selection.hasSeen) {
                  <div class="check-icon">
                    <i class="pi pi-check"></i>
                  </div>
                }
              </div>
              <div class="card-content">
                <h4>{{ selection.film.title }}</h4>
                <p>{{ selection.film.releaseYear }}</p>
              </div>
            </div>
          }
        </div>
      }

      <!-- Error State -->
      @if (recommendationsError()) {
        <div class="error-message">
          <lord-icon
            src="https://cdn.lordicon.com/tdrtiskw.json"
            trigger="loop"
            style="width: 60px; height: 60px"
          ></lord-icon>
          <p>{{ recommendationsError() }}</p>
        </div>
      }

      <!-- Action Buttons -->
      <div class="action-section" data-testid="recommendations-actions">
        <p-button
          label="Next Round"
          icon="pi pi-arrow-right"
          iconPos="right"
          [disabled]="!canProceedToNextRound() || isLoadingRecommendations()"
          [loading]="isLoadingRecommendations()"
          (onClick)="nextRound()"
          styleClass="p-button-lg"
          data-testid="recommendations-next-button"
        />
        <p-button
          label="Finish"
          icon="pi pi-check"
          [disabled]="!canProceedToNextRound() || isLoadingRecommendations()"
          [loading]="isLoadingRecommendations()"
          (onClick)="finish()"
          styleClass="p-button-lg p-button-success"
          data-testid="recommendations-finish-button"
        />
      </div>
    </div>
  }
</div>
