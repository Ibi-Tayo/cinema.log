<div class="review-container">
  <!-- Loading State -->
  @if (isLoading()) {
    <app-loading-state message="Loading film details..." />
  }

  <!-- Error State -->
  @if (errorMessage() && !isLoading()) {
    <app-error-state
      [message]="errorMessage()"
      [showRetryButton]="true"
      retryButtonLabel="Back to Search"
      (retry)="goBackToSearch()"
    />
  }

  <!-- Film Details & Review Form -->
  @if (film() && !isLoading()) {
    <div class="review-content">
      <!-- Header -->
      <div class="review-header">
        <button class="back-button" (click)="goBackToSearch()">
          <lord-icon
            src="https://cdn.lordicon.com/jarmuava.json"
            trigger="hover"
            style="width: 24px; height: 24px; transform: rotate(180deg)"
          >
          </lord-icon>
          Back to Search
        </button>
        <h1>Review Film</h1>
      </div>

      <!-- Film Display -->
      <app-film-display [film]="film()!" [filmRating]="filmRating()" />

      <!-- Comparison Section -->
      @if (showComparisons()) {
        <div class="comparison-section">
          <div class="comparison-header">
            <h2>
              <lord-icon
                src="https://cdn.lordicon.com/wrdvfxzm.json"
                trigger="hover"
                style="width: 32px; height: 32px"
              >
              </lord-icon>
              Rate Your Films
            </h2>
            <p class="comparison-description">
              Compare this film with others you've rated to build your personal
              ranking
            </p>
            <!-- Mode Toggle -->
            <div class="mode-toggle">
              <label class="toggle-label">
                <input
                  id="comparisonModeToggle"
                  name="comparisonMode"
                  type="checkbox"
                  [checked]="comparisonState.mode() === 'bulk'"
                  (change)="onToggleMode()"
                  class="toggle-checkbox"
                />
                <span class="toggle-text">
                  {{
                    comparisonState.mode() === "bulk"
                      ? "Bulk Mode"
                      : "Sequential Mode"
                  }}
                </span>
              </label>
            </div>
          </div>

          <!-- Comparison Loading -->
          @if (isLoadingComparisons()) {
            <app-loading-state message="Loading films for comparison..." />
          }

          <!-- Comparison Error -->
          @if (comparisonError()) {
            <app-error-state
              [message]="comparisonError()"
              [showRetryButton]="true"
              retryButtonLabel="Try Again"
              (retry)="loadFilmsForComparison()"
            />
          }

          <!-- No Films Available -->
          @if (
            !isLoadingComparisons() &&
            !comparisonError() &&
            filmsForComparison().length === 0
          ) {
            <div class="no-comparisons">
              <lord-icon
                src="https://cdn.lordicon.com/tdrtiskw.json"
                trigger="loop"
                style="width: 64px; height: 64px"
              >
              </lord-icon>
              <p>No more films available for comparison.</p>
              <p class="hint">Rate more films to build your ranking!</p>
            </div>
          }

          <!-- Sequential Comparison Mode -->
          @if (
            !isLoadingComparisons() &&
            !comparisonError() &&
            comparisonState.mode() === "sequential" &&
            currentComparisonFilm()
          ) {
            <app-sequential-comparison
              [targetFilm]="film()!"
              [challengerFilm]="currentComparisonFilm()!"
              [progressText]="comparisonProgress()"
              [isSubmitting]="isSubmittingComparison()"
              (comparisonResult)="onComparisonResult($event)"
            />
          }

          <!-- Bulk Comparison Mode -->
          @if (
            !isLoadingComparisons() &&
            !comparisonError() &&
            comparisonState.mode() === "bulk" &&
            filmsForComparison().length > 0
          ) {
            <app-bulk-comparison
              [targetFilm]="film()!"
              [challengerFilms]="filmsForComparison()"
              [loadedFilmsCount]="loadedFilmsCount()"
              [maxFilms]="maxBulkFilms()"
              [canLoadMore]="canLoadMore()"
              [isSubmitting]="isSubmittingComparison()"
              (batchSubmit)="onBatchSubmit()"
              (loadMore)="onLoadMore()"
            />
          }
        </div>
      }

      <!-- Review Form -->
      <app-review-form
        [hasRating]="hasRating()"
        [existingReview]="review()"
        [isSubmitting]="isSubmitting()"
        [submitSuccess]="submitSuccess()"
        [submitError]="submitError()"
        (reviewSubmit)="onReviewSubmit($event)"
        (reviewUpdate)="onReviewUpdate($event)"
      />
    </div>
  }
</div>
