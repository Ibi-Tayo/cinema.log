<div class="review-form-section" data-testid="review-form-section">
  @if (hasRating()) {
    <h3 data-testid="review-form-title">
      <lord-icon
        src="https://cdn.lordicon.com/cvwrvyjv.json"
        trigger="hover"
        style="width: 28px; height: 28px"
      >
      </lord-icon>
      Update Review
    </h3>
  } @else {
    <h3 data-testid="review-form-title">
      <lord-icon
        src="https://cdn.lordicon.com/cvwrvyjv.json"
        trigger="hover"
        style="width: 28px; height: 28px"
      >
      </lord-icon>
      Review
    </h3>
  }

  <!-- Success Message -->
  @if (submitSuccess()) {
    <div class="success-message" data-testid="review-form-success-message">
      <lord-icon
        src="https://cdn.lordicon.com/lomfljuq.json"
        trigger="loop"
        style="width: 60px; height: 60px"
      >
      </lord-icon>
      <p>Review submitted successfully</p>
    </div>
  }

  <!-- Review Form -->
  @if (!submitSuccess()) {
    <div class="review-form" data-testid="review-form">
      <!-- Rating Section (only for new reviews) -->
      @if (!hasRating()) {
        <div class="rating-section" data-testid="review-form-rating-section">
          <p class="rating-label" data-testid="review-form-rating-label">
            Rating (out of 5)
          </p>
          <div class="star-rating" data-testid="review-form-star-rating">
            <ngx-stars
              [maxStars]="5"
              [initialStars]="selectedRating()"
              [size]="28"
              [color]="'#FFD055'"
              [animation]="true"
              [wholeStars]="false"
              (ratingOutput)="selectRating($event)"
            ></ngx-stars>
          </div>
          <p class="rating-hint" data-testid="review-form-rating-hint">
            Click to rate ({{ selectedRating() || "Not rated" }})
          </p>
        </div>
      }

      <!-- Review Text Section -->
      <div class="review-text-section" data-testid="review-form-text-section">
        <label for="reviewText" data-testid="review-form-text-label"
          >Your Thoughts</label
        >
        <textarea
          id="reviewText"
          [value]="reviewText()"
          (input)="updateReviewText($any($event.target).value)"
          placeholder="Share your thoughts about this film..."
          rows="8"
          [disabled]="isSubmitting()"
          data-testid="review-form-textarea"
        ></textarea>
      </div>

      <!-- Error Message -->
      @if (submitError()) {
        <div class="error-message" data-testid="review-form-error-message">
          <lord-icon
            src="https://cdn.lordicon.com/tdrtiskw.json"
            trigger="loop"
            style="width: 24px; height: 24px"
          >
          </lord-icon>
          <p>{{ submitError() }}</p>
        </div>
      }

      <!-- Submit Button -->
      <div class="submit-section" data-testid="review-form-submit-section">
        @if (!hasRating()) {
          <button
            class="submit-button"
            (click)="onSubmitReview()"
            [disabled]="isSubmitDisabled()"
            data-testid="review-form-submit-button"
          >
            @if (!isSubmitting()) {
              <lord-icon
                src="https://cdn.lordicon.com/jvucoldz.json"
                trigger="hover"
                style="width: 24px; height: 24px"
              >
              </lord-icon>
            }
            @if (isSubmitting()) {
              <lord-icon
                src="https://cdn.lordicon.com/xjovhxra.json"
                trigger="loop"
                style="width: 24px; height: 24px"
              >
              </lord-icon>
            }
            {{ isSubmitting() ? "Submitting..." : "Submit Review" }}
          </button>
        } @else {
          <button
            class="submit-button"
            (click)="onUpdateReview()"
            [disabled]="isSubmitDisabled()"
            data-testid="review-form-update-button"
          >
            @if (!isSubmitting()) {
              <lord-icon
                src="https://cdn.lordicon.com/jvucoldz.json"
                trigger="hover"
                style="width: 24px; height: 24px"
              >
              </lord-icon>
            }
            @if (isSubmitting()) {
              <lord-icon
                src="https://cdn.lordicon.com/xjovhxra.json"
                trigger="loop"
                style="width: 24px; height: 24px"
              >
              </lord-icon>
            }
            {{ isSubmitting() ? "Submitting..." : "Update Review" }}
          </button>
        }
      </div>
    </div>
  }
</div>
