<div class="profile-container" data-testid="profile-container">
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state" data-testid="profile-loading-state">
      <lord-icon
        src="https://cdn.lordicon.com/xjovhxra.json"
        trigger="loop"
        style="width: 100px; height: 100px"
      >
      </lord-icon>
      <p>Loading profile...</p>
    </div>
  }

  <!-- Error State -->
  @if (errorMessage() && !isLoading()) {
    <div class="error-state" data-testid="profile-error-state">
      <lord-icon
        src="https://cdn.lordicon.com/tdrtiskw.json"
        trigger="loop"
        style="width: 80px; height: 80px"
      >
      </lord-icon>
      <p data-testid="profile-error-message">{{ errorMessage() }}</p>
    </div>
  }

  <!-- Profile Content -->
  @if (user() && !isLoading()) {
    <div class="profile-content" data-testid="profile-content">
      <!-- User Header -->
      <div class="profile-header" data-testid="profile-header">
        <div class="profile-avatar" data-testid="profile-avatar">
          <img [src]="user()!.profilePicUrl" [alt]="user()!.name" />
        </div>
        <div class="profile-info" data-testid="profile-info">
          <h1 data-testid="profile-name">{{ user()!.name }}</h1>
          <p class="username" data-testid="profile-username">
            {{ "@" + user()!.username }}
          </p>
          <div class="profile-meta">
            <div class="meta-item">
              <lord-icon
                src="https://cdn.lordicon.com/hmzvkifi.json"
                trigger="hover"
                style="width: 24px; height: 24px"
              >
              </lord-icon>
              <span
                >Member since {{ user()!.createdAt | date: "MMMM yyyy" }}</span
              >
            </div>
          </div>
        </div>
      </div>
      <!-- Recent Reviews Section -->
      <div class="recent-reviews-section" data-testid="profile-recent-reviews">
        <h2 data-testid="profile-recent-reviews-title">
          <lord-icon
            src="https://cdn.lordicon.com/ugllxeyl.json"
            trigger="hover"
            style="width: 32px; height: 32px; margin-right: 8px"
          >
          </lord-icon>
          Recently Reviewed Films
        </h2>
        <!-- No Reviews Placeholder -->
        @if (recentReviews().length === 0) {
          <div class="no-reviews-placeholder" data-testid="profile-no-reviews">
            <lord-icon
              src="https://cdn.lordicon.com/fpmskzsv.json"
              trigger="loop"
              style="width: 120px; height: 120px"
              colors="primary:#D3D3D3"
            >
            </lord-icon>
            <p class="placeholder-title">No Reviews Yet</p>
            <p class="placeholder-subtitle">
              Start reviewing films to see them appear here
            </p>
          </div>
        }
        <!-- Reviews Carousel -->
        @if (recentReviews().length > 0) {
          <div
            class="carousel-container"
            data-testid="profile-reviews-carousel"
          >
            <button
              class="carousel-button prev"
              (click)="previousCarouselSlide()"
              [disabled]="recentReviews().length <= 1"
              data-testid="profile-carousel-prev"
            >
              <lord-icon
                src="https://cdn.lordicon.com/zmkotitn.json"
                trigger="hover"
                style="width: 40px; height: 40px; transform: rotate(180deg)"
              >
              </lord-icon>
            </button>
            <div class="carousel-track">
              @for (review of recentReviews(); track review; let i = $index) {
                <div
                  class="carousel-slide"
                  [class.active]="i === currentCarouselIndex()"
                >
                  <div class="review-card">
                    <div
                      class="film-poster"
                      (click)="selectFilm(review.film!.id)"
                    >
                      @if (review.film?.posterUrl) {
                        <img
                          [src]="getPosterUrl(review.film?.posterUrl)"
                          [alt]="review.film?.title || 'Film poster'"
                        />
                      }
                      @if (!review.film?.posterUrl) {
                        <div class="poster-placeholder">
                          <lord-icon
                            src="https://cdn.lordicon.com/ugllxeyl.json"
                            trigger="hover"
                            style="width: 80px; height: 80px"
                          >
                          </lord-icon>
                        </div>
                      }
                    </div>
                    <div class="review-details">
                      <h3>{{ review.film?.title || "Unknown Film" }}</h3>
                      <p class="review-date">
                        {{ review.date | date: "MMM d, yyyy" }}
                      </p>
                      <div class="rating">
                        @for (star of getStars(review.rating); track $index) {
                          <span class="star" [class.filled]="star === 'full'">
                            ★
                          </span>
                        }
                      </div>
                      <p class="review-content">{{ review.title }}</p>
                    </div>
                  </div>
                </div>
              }
            </div>
            <button
              class="carousel-button next"
              (click)="nextCarouselSlide()"
              [disabled]="recentReviews().length <= 1"
            >
              <lord-icon
                src="https://cdn.lordicon.com/zmkotitn.json"
                trigger="hover"
                style="width: 40px; height: 40px"
              >
              </lord-icon>
            </button>
            <!-- Carousel Indicators -->
            <div class="carousel-indicators">
              @for (review of recentReviews(); track review; let i = $index) {
                <button
                  class="indicator"
                  [class.active]="i === currentCarouselIndex()"
                  (click)="goToSlide(i)"
                ></button>
              }
            </div>
          </div>
        }
      </div>

      <!-- Films to Review Section -->
      <div
        class="films-to-review-section"
        data-testid="profile-films-to-review"
      >
        <h2 data-testid="profile-films-to-review-title">
          <lord-icon
            src="https://cdn.lordicon.com/lecprnjb.json"
            trigger="hover"
            style="width: 32px; height: 32px; margin-right: 8px"
          >
          </lord-icon>
          Films to Review
        </h2>
        @if (filmsToReview().length === 0) {
          <div
            class="no-films-placeholder"
            data-testid="profile-no-films-to-review"
          >
            <lord-icon
              src="https://cdn.lordicon.com/egiwmiit.json"
              trigger="loop"
              style="width: 100px; height: 100px"
              colors="primary:#D3D3D3"
            >
            </lord-icon>
            <p class="placeholder-title">No Films Waiting</p>
            <p class="placeholder-subtitle">
              All your seen films have been reviewed!
            </p>
          </div>
        }
        @if (filmsToReview().length > 0) {
          <div class="films-to-review-link-card" data-testid="profile-films-to-review-link" (click)="navigateToFilmsToReview()">
            <div class="card-content">
              <lord-icon
                src="https://cdn.lordicon.com/lecprnjb.json"
                trigger="hover"
                style="width: 80px; height: 80px"
              >
              </lord-icon>
              <div class="card-text">
                <h3>You have {{ filmsToReview().length }} film{{ filmsToReview().length === 1 ? '' : 's' }} waiting for your review</h3>
                <p>Click here to view and review all your unwatched films</p>
              </div>
              <lord-icon
                src="https://cdn.lordicon.com/zmkotitn.json"
                trigger="hover"
                style="width: 40px; height: 40px"
              >
              </lord-icon>
            </div>
          </div>
        }
      </div>

      <!-- Film Ratings Table Section -->
      <div class="ratings-table-section" data-testid="profile-ratings-table">
        <h2 class="table-title" data-testid="profile-ratings-title">
          Film Rankings
        </h2>

        @if (userRatings().length === 0) {
          <div class="no-ratings-placeholder" data-testid="profile-no-ratings">
            <lord-icon
              src="https://cdn.lordicon.com/nocovwne.json"
              trigger="loop"
              style="width: 120px; height: 120px"
              colors="primary:#D3D3D3"
            >
            </lord-icon>
            <p class="placeholder-title">No Ratings Yet</p>
            <p class="placeholder-subtitle">
              Start rating films to see your rankings here
            </p>
          </div>
        }
        @if (userRatings().length > 0) {
          <div class="table-container">
            <p-table
              [value]="userRatings()"
              [paginator]="true"
              [rows]="10"
              [rowsPerPageOptions]="[5, 10, 25, 50]"
              [tableStyle]="{ 'min-width': '10rem' }"
              [globalFilterFields]="['filmTitle', 'filmReleaseYear']"
              #ratingsTable
            >
              <ng-template #header>
                <tr>
                  <th pSortableColumn="filmTitle">
                    Film <p-sortIcon field="filmTitle" />
                  </th>
                  <th pSortableColumn="rating.eloRating" style="width: 150px">
                    Elo Rating <p-sortIcon field="rating.eloRating" />
                  </th>
                  <!-- <th pSortableColumn="filmReleaseYear" style="width: 150px">
                    Release Year <p-sortIcon field="filmReleaseYear" />
                  </th>
                  <th
                    pSortableColumn="rating.initialRating"
                    style="width: 150px"
                  >
                    Review <p-sortIcon field="rating.initialRating" />
                  </th> -->
                </tr>
                <tr>
                  <th>
                    <p-iconfield iconPosition="right">
                      <input
                        id="filmSearchFilter"
                        name="filmSearch"
                        pInputText
                        type="text"
                        (input)="
                          ratingsTable.filterGlobal(
                            $any($event.target).value,
                            'contains'
                          )
                        "
                        placeholder="Search films..."
                      />
                    </p-iconfield>
                  </th>
                  <th></th>
                  <!-- <th></th>
                  <th></th> -->
                </tr>
              </ng-template>
              <ng-template #body let-ratingDetail>
                <tr>
                  <td
                    (click)="selectFilm(ratingDetail.rating.filmId)"
                    style="cursor: pointer"
                  >
                    {{ ratingDetail.eloRank }}. {{ ratingDetail.filmTitle }}
                  </td>
                  <td>{{ ratingDetail.rating.eloRating | number: "1.0-0" }}</td>
                  <!-- <td>{{ ratingDetail.filmReleaseYear }}</td>
                  <td>
                    <div class="rating-stars">
                      @for (
                        star of getStars(ratingDetail.rating.initialRating);
                        track $index
                      ) {
                        <span class="star" [class.filled]="star === 'full'">
                          ★
                        </span>
                      }
                    </div>
                  </td> -->
                </tr>
              </ng-template>
              <ng-template #emptymessage>
                <tr>
                  <td colspan="5" style="text-align: center">
                    No films found matching your criteria.
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        }
      </div>

      <!-- Film Ratings Table of films ordered by number of comparisons (ones at the top should be compared) -->
      @if (userRatingsLeastComparisons().length > 0) {
        <div
          class="ratings-table-section"
          data-testid="profile-least-comparisons-table"
        >
          <h2 class="table-title" data-testid="profile-least-comparisons-title">
            Films Needing More Comparisons
          </h2>
          <div class="table-container">
            <p-table
              [value]="userRatingsLeastComparisons()"
              [paginator]="true"
              [rows]="10"
              [rowsPerPageOptions]="[5, 10, 25, 50]"
              [tableStyle]="{ 'min-width': '10rem' }"
              [sortField]="'numberOfComparisons'"
              [sortOrder]="1"
              #leastComparisonsTable
            >
              <ng-template #header>
                <tr>
                  <th pSortableColumn="filmTitle">
                    Film <p-sortIcon field="filmTitle" />
                  </th>
                  <th pSortableColumn="numberOfComparisons">
                    Number of Comparisons
                    <p-sortIcon field="numberOfComparisons" />
                  </th>
                  <th pSortableColumn="filmReleaseYear" style="width: 150px">
                    Release Year <p-sortIcon field="filmReleaseYear" />
                  </th>
                </tr>
                <tr>
                  <th></th>
                  <th></th>
                  <th></th>
                </tr>
              </ng-template>
              <ng-template #body let-ratingDetail>
                <tr>
                  <td
                    (click)="selectFilm(ratingDetail.rating.filmId)"
                    style="cursor: pointer"
                  >
                    {{ ratingDetail.filmTitle }}
                  </td>
                  <td>{{ ratingDetail.rating.numberOfComparisons }}</td>
                  <td>{{ ratingDetail.filmReleaseYear }}</td>
                </tr>
              </ng-template>
              <ng-template #emptymessage>
                <tr>
                  <td colspan="3" style="text-align: center">
                    No films found matching your criteria.
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      }
    </div>
  }
</div>
